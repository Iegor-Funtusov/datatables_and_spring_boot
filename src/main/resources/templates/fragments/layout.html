<!doctype html>
<html th:fragment="layout (template)"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="context-path" th:content="${#request.contextPath}"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.18/af-2.3.3/b-1.5.6/b-colvis-1.5.6/b-flash-1.5.6/b-html5-1.5.6/b-print-1.5.6/cr-1.5.0/fc-3.2.5/fh-3.1.4/kt-2.5.0/r-2.2.2/rg-1.1.0/rr-1.2.4/sc-2.0.0/sl-1.3.0/datatables.min.css"/>

    <title>Datatables</title>

    <style>

        card {
            word-break: break-all !important;
        }

        table {
            border-radius: 0.25rem;
        }

        tfoot input {
            width: 100%;
            padding: 3px;
            box-sizing: border-box;
        }

        tfoot {
            display: table-header-group;
        }
    </style>

</head>
<body>
<div class="container">
    <header class="navbar navbar-expand navbar-light">

        <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item"><a class="nav-link" href="#"
                                        th:href="@{/department/list}">Departments</a></li>
                <li class="nav-item"><a class="nav-link" href="#"
                                        th:href="@{/employee/list}">Employees</a></li>
            </ul>
        </div>
    </header>

    <div th:if="${message}" class="alert alert-primary" role="alert">
        <span th:text="${message}">message text</span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
        <span th:text="${errorMessage}">message text</span>
    </div>

    <div class="container">
        <th:block th:include="${template}"/>
    </div>

</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.18/af-2.3.3/b-1.5.6/b-colvis-1.5.6/b-flash-1.5.6/b-html5-1.5.6/b-print-1.5.6/cr-1.5.0/fc-3.2.5/fh-3.1.4/kt-2.5.0/r-2.2.2/rg-1.1.0/rr-1.2.4/sc-2.0.0/sl-1.3.0/datatables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>

<script>

    function getAttributeByPageDataContainer(owner) {
        var pageDataJson = owner.getAttribute('page-data-container');
        return eval('(' + pageDataJson + ')');
    }

    function dataTableRequest(owner, pdContainer) {
        pdContainer = JSON.stringify(pdContainer);
        $('<input>').attr({
            type: 'hidden',
            name: 'datatable',
            value: pdContainer
        }).appendTo(owner);

        localStorage.setItem('pdContainer', pdContainer);

        var button = document.createElement("button");
        button.setAttribute('type', 'submit');
        button.style.visibility='hidden';
        owner.parentElement.appendChild(button);
        jQuery(button).trigger("click");
    }

    $(document).ready(function () {

        $('table.app-data-table')
            .each(
                function () {
                    var pdContainer = getAttributeByPageDataContainer(this);
                    var totalElements = pdContainer.totalElements;
                    var size = pdContainer.size;
                    var displayStart = pdContainer.displayStart;
                    var displayEnd = pdContainer.displayEnd;
                    var columnDefs = pdContainer.columnDefs;
                    var orderCol = pdContainer.orderCol;
                    var orderDir = pdContainer.orderDir;

                    $('table.app-data-table tfoot th').each(function (i) {
                        if (columnDefs.targets.find(function (value) { return value === i }) === undefined) {
                            var column =  pdContainer.dataTablesInput.columns[i];
                            if (column.search.value !== '') {
                                $(this).html('<input type="text" class="form-control" value="'+ pdContainer.search +'"/>');
                            } else {
                                var title = $(this).text();
                                $(this).html('<input type="text" class="form-control" placeholder="Search ' + title + '" />');
                            }
                        }
                    });

                    var appDataTable = $(this)
                        .DataTable(
                            {
                                dom: '<"d-flex justify-content-between"Bl>t<"d-flex justify-content-between"ip><"clear">',
                                pageLength: size,
                                order: [orderCol, orderDir],
                                fixedHeader: {
                                    footer: true
                                },
                                colReorder: true,
                                buttons: ['copy', 'excel', 'pdf', 'csv', 'colvis'],
                                columnDefs: [{
                                    "orderable": columnDefs.orderable,
                                    "searchable": columnDefs.orderable,
                                    "targets": columnDefs.targets
                                }],
                                displayStart: displayStart - 1,
                                preDrawCallback: function ( settings ) {
                                    settings.oFeatures.bServerSide = "ssp";
                                    settings.bDestroying = true;
                                    settings.fnDisplayEnd = function () {
                                        return displayEnd;
                                    };
                                    settings.fnRecordsTotal = function () {
                                        return totalElements;
                                    };
                                    settings.fnRecordsDisplay = function () {
                                        return totalElements;
                                    };
                                }
                            })
                        .on('order.dt', function (e, settings, order) {
                            pdContainer.orderCol = order[0].col;
                            pdContainer.orderDir = order[0].dir;
                            dataTableRequest(this, pdContainer);
                        })
                        .on('length.dt', function (e, settings, len) {
                            pdContainer.size = len;
                            dataTableRequest(this, pdContainer);
                        })
                        .on('page.dt', function () {
                            pdContainer.page = appDataTable.page.info().page + 1;
                            dataTableRequest(this, pdContainer);
                        });

                    appDataTable.columns().every(function (i) {
                        var that = this;
                        $('input', this.footer()).on('keyup change', function () {
                            if (that.search() !== this.value) {
                                pdContainer.dataTablesInput.columns[i].search.value = this.value;
                                pdContainer.dataTablesInput.columns[i].search.regex = true;
                                dataTableRequest(this, pdContainer);
                            }
                        });
                    });

                    appDataTable.buttons().container()
                        .appendTo('table.app-data-table_wrapper .col-sm-6:eq(0)');

                });
    });
</script>
</body>
</html>
