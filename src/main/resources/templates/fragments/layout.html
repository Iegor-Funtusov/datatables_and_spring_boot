<!doctype html>
<html th:fragment="layout (template)"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="context-path" th:content="${#request.contextPath}"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- add bootstrap 4 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- add datatables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <!-- add datatables buttons plugin -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.bootstrap4.min.css">
    <!-- add datatables fixedHeader plugin -->
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.1.5/css/fixedHeader.bootstrap4.min.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.css?v=__${'1.01'}__}">

    <title>Datatables</title>

</head>
<body>
<div class="container">
    <header class="navbar navbar-expand navbar-light">

        <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item"><a class="nav-link" href="#"
                                        th:href="@{/department/list}">Departments</a></li>
                <li class="nav-item"><a class="nav-link" href="#"
                                        th:href="@{/employee/list}">Employees</a></li>
            </ul>
        </div>
    </header>

    <div th:if="${message}" class="alert alert-primary" role="alert">
        <span th:text="${message}">message text</span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
        <span th:text="${errorMessage}">message text</span>
    </div>

    <div class="container">
        <th:block th:include="${template}"/>
    </div>

</div>

<!-- add bootstrap 4 -->
<script src="https://code.jquery.com/jquery-3.3.1.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<!-- add datatables -->
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js" type="text/javascript"></script>

<!-- add datatables buttons plugin -->
<script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.bootstrap4.min.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.colVis.min.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.flash.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.56/pdfmake.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.56/vfs_fonts.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js" type="text/javascript"></script>

<!-- add datatables fixedHeader plugin -->
<script src="https://cdn.datatables.net/fixedheader/3.1.5/js/dataTables.fixedHeader.min.js" type="text/javascript"></script>

<script>

    function getAttributeByPageDataContainer(owner) {
        var pageDataJson = owner.getAttribute('page-data-container');
        return eval('(' + pageDataJson + ')');
    }

    function dataTableRequest(owner, pdContainer) {
        pdContainer = JSON.stringify(pdContainer);
        $('<input>').attr({
            type: 'hidden',
            name: 'datatable',
            value: pdContainer
        }).appendTo(owner);

        localStorage.setItem('pdContainer', pdContainer);

        var button = document.createElement("button");
        button.setAttribute('type', 'submit');
        button.style.visibility = 'hidden';
        owner.parentElement.appendChild(button);
        jQuery(button).trigger("click");
    }

    $(document).ready(function () {

        $('table.app-data-table')
            .each(
                function () {
                    var pdContainer = getAttributeByPageDataContainer(this);
                    var totalElements = pdContainer.totalElements;
                    var size = pdContainer.size;
                    var displayStart = pdContainer.displayStart;
                    var displayEnd = pdContainer.displayEnd;
                    var columnDefs = pdContainer.columnDefs;
                    var orderCol = pdContainer.orderCol;
                    var orderDir = pdContainer.orderDir;

                    // $('table.app-data-table tfoot th').each(function (i) {
                    //     if (columnDefs.targets.find(function (value) { return value === i }) === undefined) {
                    //         var column =  pdContainer.dataTablesInput.columns[i];
                    //         if (column.search.value !== '') {
                    //             $(this).html('<input type="text" class="form-control" value="'+ pdContainer.search +'"/>');
                    //         } else {
                    //             var title = $(this).text();
                    //             $(this).html('<input type="text" class="form-control" placeholder="Search ' + title + '" />');
                    //         }
                    //     }
                    // });

                    var appDataTable = $(this)
                        .DataTable(
                            {
                                fixedHeader: true,
                                pageLength: size,
                                pagingType: "full",
                                order: [orderCol, orderDir],
                                buttons: [
                                    'colvis',
                                    'copyHtml5',
                                    'csvHtml5',
                                    'excelHtml5',
                                    'pdfHtml5',
                                    'print'
                                ],
                                columnDefs: [{
                                    "orderable": columnDefs.orderable,
                                    "searchable": columnDefs.orderable,
                                    "targets": columnDefs.targets
                                }],
                                displayStart: displayStart - 1,
                                dom: '<"dom_wrapper fh-fixedHeader"<"d-flex justify-content-between"Bl>>t<"d-flex justify-content-between"ip><"clear">',
                                preDrawCallback: function (settings) {
                                    settings.oFeatures.bServerSide = "ssp";
                                    settings.bDestroying = true;
                                    settings.fnDisplayEnd = function () {
                                        return displayEnd;
                                    };
                                    settings.fnRecordsTotal = function () {
                                        return totalElements;
                                    };
                                    settings.fnRecordsDisplay = function () {
                                        return totalElements;
                                    };
                                }
                            })
                        .on('order.dt', function (e, settings, order) {
                            pdContainer.orderCol = order[0].col;
                            pdContainer.orderDir = order[0].dir;
                            dataTableRequest(this, pdContainer);
                        })
                        .on('length.dt', function (e, settings, len) {
                            pdContainer.size = len;
                            dataTableRequest(this, pdContainer);
                        })
                        .on('page.dt', function () {
                            pdContainer.page = appDataTable.page.info().page + 1;
                            dataTableRequest(this, pdContainer);
                        });

                    // appDataTable.columns().every(function (i) {
                    //     var that = this;
                    //     $('input', this.footer()).on('keyup change', function () {
                    //         if (that.search() !== this.value) {
                    //             pdContainer.dataTablesInput.columns[i].search.value = this.value;
                    //             pdContainer.dataTablesInput.columns[i].search.regex = true;
                    //             dataTableRequest(this, pdContainer);
                    //         }
                    //     });
                    // });

                    appDataTable.buttons().container()
                        .appendTo('table.app-data-table_wrapper .col-sm-6:eq(0)');

                });
    });
</script>
</body>
</html>
